CRIE UM PRD COMPLETO e profissional para o seguinte :


# 1. Vis√£o Geral

Backend de automa√ß√£o de trading para exchanges (inicialmente Binance Spot via CCXT), com:

* Recebimento de **sinais de trading via webhooks** (TradingView etc.).
* Execu√ß√£o de **ordens autom√°ticas** em m√∫ltiplas contas e m√∫ltiplas corretoras.
* **Gerenciamento de cofres virtuais** (vaults) para controlar capital.
* **Posi√ß√µes agregadas** com suporte a:

  * m√∫ltiplas compras/vendas,
  * vendas parciais,
  * FIFO,
  * SL/TP/Trailing,
  * **trava de venda por webhook**.
* **Modo de simula√ß√£o** (backtesting ‚Äúonline‚Äù via webhooks de teste).
* Notifica√ß√µes via **WhatsApp (Evolution API)**.
* APIs espec√≠ficas para **relat√≥rios e dashboards**.

Frontend ser√° feito depois; este PRD cobre apenas o **backend/API + workers**.

---

# 2. Stack T√©cnica

* **Runtime**: Node.js 22+
* **Gerenciador**: `pnpm` (monorepo)
* **Framework API**: NestJS (recomendado) ou Fastify com estrutura modular equivalente.
* **Banco de Dados**: MySQL 8 (InnoDB, UTF8MB4) - instala√ß√£o local ou servi√ßo gerenciado
* **ORM**: Prisma
* **Filas & Locks**: Redis + BullMQ - instala√ß√£o local ou servi√ßo gerenciado
* **Exchange**: CCXT (`binance`, etc.) para modo REAL e leitura de pre√ßo; no modo SIMULA√á√ÉO, apenas leitura de pre√ßo.
* **Notifica√ß√µes**: Evolution API (WhatsApp) via HTTP client.
* **Auth**: JWT + 2FA (TOTP)
* **Documenta√ß√£o API**: OpenAPI 3.0 (Swagger) com UI interativa e export JSON

---

# 3. Arquitetura de Alto N√≠vel

## 3.1. Monorepo

```text
/apps
  /api         -> API HTTP (REST) para frontend + webhooks + admin
  /executor    -> worker de execu√ß√£o de ordens (real e simula√ß√£o)
  /monitors    -> jobs agendados: SL/TP, simula√ß√£o, cofres, sync, relat√≥rios
/packages
  /db          -> Prisma Client, migrations e tipos DB
  /domain      -> regras de neg√≥cio (trading, cofres, webhooks, posi√ß√µes)
  /exchange    -> adapters CCXT por exchange
  /notifications -> cliente WhatsApp, abstra√ß√£o de notifica√ß√£o
  /shared      -> config, logger, helpers, tipos compartilhados
```

## 3.2. Componentes

* **API Service (`apps/api`)**:

  * Autentica√ß√£o usu√°rios.
  * CRUD de contas de exchange, par√¢metros, cofres, webhooks.
  * Endpoints de posi√ß√µes, jobs, execu√ß√µes, relat√≥rios.
  * Endpoint p√∫blico de webhook (`/webhooks/:code`) com seguran√ßa.

* **Executor Service (`apps/executor`)**:

  * Worker BullMQ para:

    * execu√ß√£o de ordens REAL (CCXT),
    * execu√ß√£o de ordens SIMULA√á√ÉO (sem enviar nada √† exchange).
  * Atualiza jobs, execu√ß√µes, posi√ß√µes e cofres.

* **Monitors Service (`apps/monitors`)**:

  * Jobs repetitivos:

    * Monitor de SL/TP / trailing.
    * Monitor para modo SIMULA√á√ÉO (separado).
    * Sync de saldos e ordens reais.
    * Monitores de cofres (alertas).
    * Gera√ß√£o de m√©tricas agregadas (materialized views simples para relat√≥rios).

---

# 4. Dom√≠nios e Funcionalidades

## 4.1. Usu√°rios e Autentica√ß√£o

**Tabelas:**

* `users`

  * `id`
  * `email` (√∫nico)
  * `password_hash`
  * `is_active`
  * `must_change_password`
  * `created_at`, `updated_at`

* `profiles`

  * `user_id` (FK)
  * `full_name`
  * `phone`
  * `whatsapp_phone`
  * flags de alertas (position_alerts_enabled, etc.)
  * `twofa_enabled`, `twofa_secret`
  * `created_at`, `updated_at`

* `user_roles`

  * `user_id`
  * `role` (`admin` | `user`)

* `login_history`

  * `id`
  * `user_id`
  * `ip`
  * `user_agent`
  * `success` (bool)
  * `created_at`

* `audit_logs`

  * `id`
  * `user_id` (quem executou a a√ß√£o)
  * `entity_type` (enum: `USER`, `EXCHANGE_ACCOUNT`, `VAULT`, `POSITION`, `WEBHOOK_SOURCE`, `TRADE_JOB`, etc.)
  * `entity_id` (ID do registro afetado)
  * `action` (enum: `CREATE`, `UPDATE`, `DELETE`, `LOGIN`, `LOGOUT`, `PASSWORD_CHANGE`, `2FA_ENABLE`, `2FA_DISABLE`, etc.)
  * `changes_json` (antes/depois em JSON para UPDATEs)
  * `ip`
  * `user_agent`
  * `request_id` (correla√ß√£o com logs da aplica√ß√£o)
  * `created_at`

* `system_audit_logs`

  * `id`
  * `service` (enum: `API`, `EXECUTOR`, `MONITORS`)
  * `event_type` (ex: `CRON_EXECUTED`, `ORDER_PLACED`, `WEBHOOK_RECEIVED`, `POSITION_CLOSED`, etc.)
  * `entity_type` (opcional)
  * `entity_id` (opcional)
  * `severity` (enum: `INFO`, `WARNING`, `ERROR`, `CRITICAL`)
  * `message`
  * `metadata_json`
  * `created_at`

**Funcionalidades:**

* Login (email + senha) ‚Üí JWT Access + Refresh.
* Setup e verifica√ß√£o de 2FA (TOTP).
* For√ßar troca de senha em primeiro login / reset.
* Autoriza√ß√£o baseada em role (`admin` vs `user`).

---

## 4.2. Contas de Exchange

**Tabela: `exchange_accounts`**

* `id`
* `user_id` (owner)
* `exchange` (`BINANCE_SPOT`, `BINANCE_FUTURES`, `BYBIT_SPOT`, etc.)
* `label`
* `is_simulation` (bool):

  * `0` = conta real (usa API keys)
  * `1` = conta de simula√ß√£o (sem API key ou s√≥ para leitura de pre√ßo)
* `api_key_enc` (NULL se simula√ß√£o)
* `api_secret_enc` (NULL se simula√ß√£o)
* `proxy_url` (opcional)
* `testnet` (bool)
* `is_active` (bool)
* `initial_balances_json` (apenas para simula√ß√£o; p.ex `{ "USDT": 1000 }`)
* `created_at`, `updated_at`

**Servi√ßo: `ExchangeAccountService`**

* CRUD de contas de exchange.
* Teste de conex√£o para contas reais (`testConnection()` via CCXT).
* Para simula√ß√£o:

  * inicializar saldos no cache interno (`account_balances_cache` em modo SIM).

---

## 4.3. Cofres (Vaults)

**Tabelas:**

* `vaults`

  * `id`
  * `user_id`
  * `name`
  * `description`
  * `trade_mode` (`REAL` | `SIMULATION`)
  * `is_active`
  * `created_at`, `updated_at`

* `vault_balances`

  * `id`
  * `vault_id`
  * `asset` (ex: `USDT`)
  * `balance`
  * `reserved`
  * `created_at`, `updated_at`

* `vault_transactions`

  * `id`
  * `vault_id`
  * `type` (`DEPOSIT`, `WITHDRAWAL`, `BUY_RESERVE`, `BUY_CONFIRM`, `BUY_CANCEL`, `SELL_RETURN`)
  * `asset`
  * `amount`
  * `trade_job_id` (FK opcional)
  * `meta_json`
  * `created_at`

**Servi√ßo: `VaultService`**

* M√©todos principais:

  * `deposit(vaultId, asset, amount)`
  * `withdraw(vaultId, asset, amount)`
  * `reserveForBuy(jobId, vaultId, asset, amount)`
  * `confirmBuy(jobId, vaultId, asset, amount)`
  * `cancelBuy(jobId, vaultId, asset, amount)`
  * `creditOnSell(jobId, vaultId, asset, amount)`

Sempre com transa√ß√µes MySQL e `SELECT ... FOR UPDATE` em `vault_balances`.

---

## 4.4. Par√¢metros de Trading

**Tabela: `trade_parameters`**

* `id`
* `exchange_account_id`
* `symbol` (`"SOL/USDT"`, `"BTC/USDT"`)
* `side` (`BUY`, `SELL`, `BOTH`)
* **Tamanho da ordem:**

  * `quote_amount_fixed` (decimal, ex: 10 USDT)
  * `quote_amount_pct_balance` (decimal, ex: 1.5 = 1.5% do saldo)
* **Limiter de frequ√™ncia:**

  * `max_orders_per_hour` (int, opcional)
  * `min_interval_sec` (int, opcional)
* **Execu√ß√£o:**

  * `order_type_default` (`MARKET` | `LIMIT`)
  * `slippage_bps` (int, base points)
* **SL/TP padr√£o (por par√¢metro):**

  * `default_sl_enabled`, `default_sl_pct`
  * `default_tp_enabled`, `default_tp_pct`
  * `trailing_stop_enabled`, `trailing_distance_pct`
* **Cofre:**

  * `vault_id` (FK opcional)

Servi√ßo: `TradeParameterService`:

* `computeQuoteAmount(accountId, symbol, side, trade_mode)`:

  * Usa saldo (real ou simula√ß√£o).
* `canOpenNewOrder(accountId, symbol, side)`:

  * Checa `max_orders_per_hour`, `min_interval_sec`.

---

## 4.5. Webhook Sources, Bindings e Events

### 4.5.1. `webhook_sources`

* `id`
* `owner_user_id`
* `label`
* `webhook_code` (slug usado na URL: `/webhooks/:code`, √∫nico)
* `trade_mode` (`REAL` | `SIMULATION`)
* `allowed_ips_json` (lista de IPs ou CIDRs permitidos)
* `require_signature` (bool)
* `signing_secret_enc` (opcional, para HMAC)
* `rate_limit_per_min` (int)
* `is_active` (bool)
* `admin_locked` (bool)
* `created_at`, `updated_at`

### 4.5.2. `account_webhook_bindings`

* `id`
* `webhook_source_id`
* `exchange_account_id`
* `is_active`
* `weight` (opcional, ex: multiplicador de tamanho de ordem)
* `created_at`, `updated_at`

### 4.5.3. `webhook_events`

* `id`
* `webhook_source_id`
* `target_account_id` (exchange_account_id)
* `trade_mode` (`REAL` | `SIMULATION`)
* `event_uid` (string: ID do sinal / hash do payload)
* `symbol_raw` (ex: `SOLUSDT.P` vindo do webhook)
* `symbol_normalized` (ex: `SOLUSDT` ‚Üí usado nos par√¢metros/APIs da exchange)
* `action` (`BUY_SIGNAL`, `SELL_SIGNAL`, `UNKNOWN`)
* `timeframe` (string, ex: `H1`)
* `price_reference` (decimal ‚Äì pre√ßo vindo do alerta)
* `raw_text` (texto original do webhook)
* `raw_payload_json` (payload inteiro recebido)
* `status` (`RECEIVED`, `JOB_CREATED`, `SKIPPED`, `FAILED`)
* `validation_error` (texto opcional)
* `created_at`, `processed_at`

**Idempot√™ncia:**

* √çndice √∫nico:

  * `UNIQUE (webhook_source_id, event_uid, target_account_id)`

Se o mesmo webhook/replay chegar, ele n√£o cria novo evento para aquele alvo.

---

## 4.6. Trade Jobs, Execu√ß√µes e Saldos

### 4.6.1. `trade_jobs`

* `id`
* `webhook_event_id` (FK opcional, nulo em jobs de monitores)
* `exchange_account_id`
* `trade_mode` (`REAL` | `SIMULATION`)
* `symbol` (normalizado, ex: `SOL/USDT`)
* `side` (`BUY` | `SELL`)
* `order_type` (`MARKET`, `LIMIT`, etc.)
* `quote_amount` (USDT)
* `base_quantity` (SOL, BTC, etc.)
* `limit_price` (se order_type = LIMIT ou STOP)
* `status`:

  * `PENDING`
  * `EXECUTING`
  * `FILLED`
  * `PARTIALLY_FILLED` (opcional)
  * `FAILED`
  * `SKIPPED`
  * `CANCELED`
  * `PENDING_LIMIT` (ordem LIMIT criada, aguardando execu√ß√£o na exchange)
* `reason_code` (enum textual, ex: `NO_POSITION_AVAILABLE`, `RULE_BLOCKED`, `WEBHOOK_LOCK`, etc.)
* `reason_message` (texto livre)
* `vault_id` (FK opcional)
* `limit_order_expires_at` (timestamp, opcional - para ordens LIMIT com expira√ß√£o)
* `created_at`, `updated_at`

### 4.6.2. `trade_executions`

* `id`
* `trade_job_id`
* `exchange_account_id`
* `trade_mode` (`REAL` | `SIMULATION`)
* `exchange` (enum)
* `exchange_order_id` (null em simula√ß√£o, ou `SIM-<uuid>`)
* `client_order_id` (string)
* `status_exchange` (`NEW`, `FILLED`, `PARTIALLY_FILLED`, `CANCELED`, `REJECTED`, etc.)
* `executed_qty`
* `cumm_quote_qty`
* `avg_price`
* `fills_json` (lista de fills raw, se quiser)
* `raw_response_json` (Respostas da exchange ou objeto de simula√ß√£o)
* `created_at`

### 4.6.3. `account_balances_cache`

* `id`
* `exchange_account_id`
* `trade_mode`
* `asset`
* `free`
* `locked`
* `last_sync_at`

---

## 4.7. POSI√á√ïES (core)

### 4.7.1. `trade_positions`

* `id`
* `exchange_account_id`
* `trade_mode` (`REAL` | `SIMULATION`)
* `symbol` (ex: `SOL/USDT`)
* `side` (`LONG`)  *(por ora s√≥ spot long; futuro pode ter `SHORT`)*
* `trade_job_id_open` (FK para o job de compra que criou esta posi√ß√£o)

**Quantidades:**

* `qty_total` (quantidade total comprada na abertura)
* `qty_remaining` (quantidade ainda aberta; se 0 ‚Üí CLOSED)

**Pre√ßo:**

* `price_open` (pre√ßo de compra da posi√ß√£o)

**Status:**

* `status`:

  * `OPEN` (posi√ß√£o aberta, qty_remaining > 0)
  * `CLOSED` (posi√ß√£o totalmente fechada, qty_remaining = 0)

**PnL:**

* `realized_profit_usd` (soma de PnL realizados em vendas ligadas √† posi√ß√£o)
* (PnL n√£o realizado ser√° calculado ad-hoc via pre√ßo atual)

**Configura√ß√£o SL/TP por posi√ß√£o:**

* `sl_enabled`, `sl_pct`
* `tp_enabled`, `tp_pct`
* `trailing_enabled`, `trailing_distance_pct`, `trailing_max_price`

**Flags de disparo:**

* `sl_triggered`
* `tp_triggered`
* `trailing_triggered`
* `partial_tp_triggered`

**Trava de venda por webhook:**

* `lock_sell_by_webhook` (TINYINT(1) DEFAULT 0)

  * `0` ‚Üí posi√ß√£o pode ser usada em vendas disparadas por webhook.
  * `1` ‚Üí posi√ß√£o **n√£o entra** na fila de posi√ß√µes escolhidas quando o sinal for via webhook de venda.

**Fechamento:**

* `close_reason` (`TARGET_HIT`, `STOP_LOSS`, `MANUAL`, `WEBHOOK_SELL`, `RECONCILIATION`, etc.)
* `closed_at`
* `created_at`, `updated_at`

### 4.7.2. `position_fills`

Para rastrear execu√ß√µes associadas a posi√ß√µes (tanto compras quanto vendas parciais/totais):

* `id`
* `position_id` (FK para trade_positions)
* `trade_execution_id` (FK para trade_executions)
* `side` (`BUY` | `SELL`)
* `qty` (quantidade da execu√ß√£o aplicada a esta posi√ß√£o)
* `price` (pre√ßo da execu√ß√£o)
* `created_at`

**Observa√ß√£o**: Uma posi√ß√£o sempre ter√° exatamente 1 fill de BUY (abertura) e pode ter m√∫ltiplos fills de SELL (vendas parciais) at√© o fechamento total.

---

## 4.8. L√≥gica de POSI√á√ÉO (lifecycle)

### 4.8.1. Abertura (BUY executado)

1. Executor trata `trade_execution` de BUY (real ou simulado).

2. `PositionService.onBuyExecuted(job, execution)`:

   * **Sempre cria uma nova posi√ß√£o** para cada compra executada:
     * Insere nova linha em `trade_positions` com:
       * `trade_job_id_open` = job.id
       * `qty_total` = executed_qty
       * `qty_remaining` = executed_qty
       * `price_open` = avg_price da execu√ß√£o
       * `status` = 'OPEN'
   * Registrar `position_fills` com `side=BUY` (opcional, para auditoria).

3. Se job tiver `vault_id`:

   * `VaultService.confirmBuy(...)`

4. Notifica√ß√£o de posi√ß√£o aberta, se configurado.

### 4.8.2. Venda (SELL executado)

Ao executar venda de um `trade_job` SELL:

1. Executor cria `trade_execution`.

2. `PositionService.onSellExecuted(job, execution)`:

   * Seleciona posi√ß√µes **eleg√≠veis** (FIFO):

     ```sql
     SELECT *
     FROM trade_positions
     WHERE exchange_account_id = :accountId
       AND trade_mode = :tradeMode
       AND symbol = :symbol
       AND side = 'LONG'
       AND status = 'OPEN'
       AND qty_remaining > 0
       AND lock_sell_by_webhook = (
         CASE 
           WHEN :origin = 'WEBHOOK' THEN 0
           ELSE lock_sell_by_webhook -- para SL/TP/manual, pode ignorar ou n√£o
         END
       )
     ORDER BY created_at ASC
     FOR UPDATE;
     ```

     * `origin` √© inferida do `trade_job` (ex: `WEBHOOK`, `STOP_LOSS`, `TAKE_PROFIT`, `MANUAL`).

   * Percorre essas posi√ß√µes em FIFO, consumindo `qty_remaining` at√© bater `executed_qty`.

   * Para cada posi√ß√£o:

     * `qty_to_close` = min(`pos.qty_remaining`, `remaining_to_sell`).

     * Calcula PnL:

       * `profit_usd = (sell_price - price_open) * qty_to_close`.

     * Atualiza:

       * `qty_remaining -= qty_to_close`.
       * `realized_profit_usd += profit_usd`.
       * `status`:

         * se `qty_remaining = 0` ‚Üí `CLOSED`, `closed_at` e `close_reason` conforme origem.
         * se > 0 ‚Üí permanece `OPEN` (venda parcial).

     * Insere em `position_fills` com `side=SELL` para rastreabilidade.

3. Se nenhum posi√ß√£o eleg√≠vel:

   * `trade_job.status = SKIPPED`
   * `reason_code = 'NO_ELIGIBLE_POSITIONS'` ou `WEBHOOK_LOCK` se trancadas.

4. Cofre:

   * Para vendas de compra originada por cofre:

     * `VaultService.creditOnSell(...)`.

5. Notifica√ß√£o de fechamento/parcial.

---

## 4.9. SL/TP / Trailing

**Monitor SL/TP (REAL e SIM separados):**

1. Seleciona posi√ß√µes `OPEN` com SL/TP habilitado (qty_remaining > 0).

2. Pega pre√ßo atual via CCXT (read-only).

3. Calcula:

   ```text
   pnl_pct = (current_price - price_open) / price_open * 100
   ```

4. Regras:

   * Se `sl_enabled` e `pnl_pct <= -sl_pct`:

     * cria `trade_job` SELL da `qty_remaining` (PENDING, origin `STOP_LOSS`).
   * Se `tp_enabled` e `pnl_pct >= tp_pct`:

     * se `partial_tp_enabled`:

       * cria SELL de `qty_remaining * partial_tp_sell_pct`.
     * sen√£o:

       * SELL de tudo.

5. Trailing:

   * Atualiza `trailing_max_price` quando pre√ßo sobe.
   * Se `current_price <= trailing_max_price * (1 - trailing_distance_pct/100)`:

     * cria SELL.

---

## 4.10. Modo de SIMULA√á√ÉO

### 4.10.1. Campo `trade_mode`

Presente em:

* `webhook_sources.trade_mode`
* `webhook_events.trade_mode`
* `trade_jobs.trade_mode`
* `trade_executions.trade_mode`
* `trade_positions.trade_mode`
* `vaults.trade_mode`, `vault_balances.trade_mode` (se houver cofres de simula√ß√£o)

Valores:

* `'REAL'`
* `'SIMULATION'`

### 4.10.2. Webhook em modo SIM

* `webhook_sources.trade_mode = 'SIMULATION'`
* `account_webhook_bindings` apontam para `exchange_accounts.is_simulation = 1`.
* `webhook_events.trade_mode = 'SIMULATION'`.

Pipeline:

1. `webhooks/:code` ‚Üí evento em modo SIM.
2. Worker `webhook-to-job-sim`:

   * cria `trade_jobs` com `trade_mode = 'SIMULATION'`.
3. Worker executor de simula√ß√£o:

   * N√ÉO chama `createOrder` na exchange.
   * Determina pre√ßo de execu√ß√£o:

     * Se payload tiver pre√ßo expl√≠cito, usa.
     * Sen√£o, l√™ `fetchTicker(symbol)` s√≥ para `last`.
   * Calcula `executed_qty` e `avg_price`.
   * Gera `trade_executions` com `exchange_order_id = 'SIM-...'`.
   * Chama `PositionService.onBuyExecuted/onSellExecuted` igualmente.
   * Atualiza cofres de simula√ß√£o (se houver).

### 4.10.3. Relat√≥rios de simula√ß√£o

* Possibilidade de ver apenas `trade_mode = 'SIMULATION'` em:

  * posi√ß√µes
  * execu√ß√µes
  * PnL
  * compara√ß√µes com o modo REAL posteriormente.

---

## 4.11. Notifica√ß√µes (WhatsApp)

Tabelas:

* `whatsapp_global_config`
* `whatsapp_notifications_config`
* `position_alerts_sent`
* `vault_alerts_sent`

Servi√ßo: `NotificationService` + `WhatsAppClient`.

Eventos que podem disparar notifica√ß√£o:

* `POSITION_OPENED`
* `POSITION_CLOSED`
* `STOP_LOSS_TRIGGERED`
* `PARTIAL_TP_TRIGGERED`
* (mais para frente: falhas de opera√ß√£o, etc.)

---

# 5. Protocolo do Webhook e Parsing de Texto

## 5.1. Modelo de texto recebido

Exemplos:

```text
SOLUSDT.P Ca√ßa Fundo üü¢ (H1) Pre√ßo (213.09)

SOLUSDT.P Ca√ßa Topo üî¥ (H1) Pre√ßo (215.81)
```

Legenda:

* `SOLUSDT.P`:

  * `symbol_raw`: `SOLUSDT.P`
  * parser deve identificar o ‚Äúativo base‚Äù e, se necess√°rio, mapear:

    * `symbol_normalized`: `SOLUSDT` ou `SOLUS/USDT` (conforme par√¢metro de conta).
    * O sufixo `.P` pode ser tratado como metadado (perp√©tuo, futuro, etc.).
* `Ca√ßa Fundo` (üü¢):

  * sinal de **compra** ‚Üí `action = BUY_SIGNAL`.
* `Ca√ßa Topo` (üî¥):

  * sinal de **venda** ‚Üí `action = SELL_SIGNAL`.
* `(H1)`:

  * timeframe ‚Üí `timeframe = 'H1'`.
* `Pre√ßo (213.09)`:

  * `price_reference = 213.09`.

## 5.2. Regras de parsing

* Ao receber o webhook:

  * Extrair:

    * `symbol_raw` (primeira ‚Äúpalavra‚Äù at√© o primeiro espa√ßo).
    * `pattern_name` (`Ca√ßa Fundo`, `Ca√ßa Topo`, se poss√≠vel).
    * `emoji` (n√£o √© essencial, mas pode ser guardado).
    * `timeframe` (conte√∫do dentro de `(...)` perto do TF, ex: `H1`).
    * `price_reference` (conte√∫do num√©rico dentro de `Pre√ßo (...)`).
  * Mapeamento de a√ß√£o:

    * Se contiver `Ca√ßa Fundo` **ou** emoji verde:

      * `action = BUY_SIGNAL`.
    * Se contiver `Ca√ßa Topo` **ou** emoji vermelho:

      * `action = SELL_SIGNAL`.
  * `symbol_normalized`:

    * Regra inicial: remover sufixos `.P`, `.F`, etc. se necess√°rio.
    * Mapear para formato de s√≠mbolo CCXT da conta:

      * Ex: `SOLUSDT` ‚Üí `SOL/USDT` conforme adapter.
  * `event_uid`:

    * Pode ser:

      * ID vindo do payload, ou
      * hash do `symbol_raw + timeframe + price_reference + timestamp`, para evitar duplicados.

Essas informa√ß√µes alimentam `webhook_events`.

---

## 5.3. Seguran√ßa do webhook (IP + assinatura)

Na entrada `POST /webhooks/:code`:

1. Resolver `webhook_source` por `webhook_code`.
2. Validar se `is_active` e n√£o `admin_locked`.
3. **Valida√ß√£o de IP**:

   * `allowed_ips_json`: lista de IPs e/ou CIDRs permitidos.
   * Obter IP real do request (considerando proxy/reverse-proxy).
   * Verificar se o IP est√° na lista/cidr; se **n√£o estiver**:

     * Registrar entrada em `webhook_blocked_attempts`.
     * Responder com 403 e n√£o processar.
4. **Assinatura (opcional)**:

   * Se `require_signature = true`:

     * Ler header, por exemplo `X-Signature`.
     * Calcular HMAC-SHA256 do body com `signing_secret` (decriptado).
     * Comparar com header; se inv√°lido:

       * registrar blocked attempt.
       * responder 403.
5. Rate limiting:

   * Checar `rate_limit_per_min`.
   * Se excedido, retornar 429 ou aceitar mas marcar como bloqueado.

Se tudo ok, segue pipeline: criar `webhook_events` e jobs.

---

# 6. Monitores e Workers

## 6.1. Executor (`apps/executor`)

* Workers:

  * `trade-execution-real`:

    * processa `trade_jobs.trade_mode = REAL`.
    * chama CCXT para `createOrder()`.
  * `trade-execution-sim`:

    * processa `trade_jobs.trade_mode = SIMULATION`.
    * simula ordens sem enviar para corretoras.

Ambos chamam `PositionService` e `VaultService`.

## 6.2. Monitors (`apps/monitors`)

Jobs repetitivos (BullMQ repeatables):

* `sl_tp_monitor_real`
* `sl_tp_monitor_sim`
* `limit_orders_monitor_real`
* `limit_orders_monitor_sim`
* `vault_balance_monitor`
* `balances_sync_real`
* `orders_sync_real`
* (futuro) gera√ß√£o de snapshots para relat√≥rios.

**Monitor de Ordens LIMIT (`limit_orders_monitor_real` / `_sim`):**

1. Seleciona `trade_jobs` com:
   * `status = 'PENDING_LIMIT'`
   * `order_type = 'LIMIT'`
   * `trade_mode` correspondente (REAL ou SIMULATION)

2. Para cada ordem:

   * **Modo REAL**:
     * Consulta status via `exchange.fetchOrder(exchange_order_id)`
     * Se `status = 'FILLED'`:
       * Atualiza `trade_job.status = FILLED`
       * Cria `trade_execution` com dados reais
       * Chama `PositionService.onSellExecuted` ou `onBuyExecuted`
     * Se `status = 'CANCELED'` ou `'EXPIRED'`:
       * Atualiza `trade_job.status = CANCELED`
       * Libera recursos (cofre, se aplic√°vel)

   * **Modo SIMULATION**:
     * Consulta pre√ßo atual via `fetchTicker`
     * Se pre√ßo atingiu `limit_price` (considerando lado):
       * Simula execu√ß√£o
       * Atualiza status e cria execution

3. Verifica expira√ß√£o:
   * Se `limit_order_expires_at` passou:
     * Cancela ordem automaticamente
     * Marca `trade_job.status = CANCELED`
     * `reason_code = 'EXPIRED'`

4. Frequ√™ncia: a cada 30-60 segundos (configur√°vel).

---

# 7. Endpoints da API (incluindo RELAT√ìRIOS)

## 7.1. Auth & Usu√°rio

* `POST /auth/login`
* `POST /auth/refresh`
* `POST /auth/2fa/setup`
* `POST /auth/2fa/verify`
* `GET /me`
* `PUT /me`
* `GET /me/login-history`

Admin:

* `GET /admin/users`
  * Listar todos os usu√°rios com filtros (role, is_active, email, etc.)
  * Pagina√ß√£o e ordena√ß√£o
  * Inclui estat√≠sticas (√∫ltimo login, n√∫mero de contas, posi√ß√µes abertas)

* `GET /admin/users/:id`
  * Detalhes completos do usu√°rio
  * Perfil, roles, hist√≥rico de login
  * Contas de exchange vinculadas
  * Resumo de atividade (trades, posi√ß√µes, webhooks)

* `POST /admin/users`
  * Criar novo usu√°rio
  * Gerar senha tempor√°ria
  * For√ßar troca de senha no primeiro login
  * Enviar email/WhatsApp de boas-vindas

* `PUT /admin/users/:id`
  * Atualizar dados do usu√°rio
  * Alterar role (admin/user)
  * Ativar/desativar conta
  * Reset de senha for√ßado

* `DELETE /admin/users/:id`
  * Desativa√ß√£o l√≥gica (soft delete)
  * Op√ß√£o de exclus√£o f√≠sica (hard delete) - requer confirma√ß√£o
  * Valida√ß√£o: n√£o permite deletar se houver posi√ß√µes abertas

* `POST /admin/users/:id/activate`
  * Reativar usu√°rio desativado

* `POST /admin/users/:id/reset-password`
  * Gerar nova senha tempor√°ria
  * For√ßar troca no pr√≥ximo login
  * Enviar credenciais por email/WhatsApp

* `POST /admin/users/:id/reset-2fa`
  * Desabilitar 2FA do usu√°rio (emerg√™ncia)
  * Notificar usu√°rio da altera√ß√£o

* `GET /admin/users/:id/sessions`
  * Listar sess√µes ativas do usu√°rio
  * Detalhes de IP, user agent, data de cria√ß√£o

* `DELETE /admin/users/:id/sessions`
  * Revogar todas as sess√µes do usu√°rio (logout for√ßado)

* `GET /admin/users/:id/audit-logs`
  * Hist√≥rico de a√ß√µes do usu√°rio
  * Filtros por entity_type, action, data

---

## 7.2. Contas de Exchange

* `GET /exchange-accounts`
* `POST /exchange-accounts`
* `PUT /exchange-accounts/:id`
* `DELETE /exchange-accounts/:id`
* `POST /exchange-accounts/:id/test-connection`

---

## 7.3. Cofres

* `GET /vaults`
* `POST /vaults`
* `PUT /vaults/:id`
* `GET /vaults/:id/balances`
* `GET /vaults/:id/transactions`
* `POST /vaults/:id/deposit`
* `POST /vaults/:id/withdraw`

---

## 7.4. Par√¢metros de Trading

* `GET /trade-parameters`
* `POST /trade-parameters`
* `PUT /trade-parameters/:id`
* `DELETE /trade-parameters/:id`

Templates:

* `GET /parameter-templates`
* `POST /parameter-templates`
* `PUT /parameter-templates/:id`
* `DELETE /parameter-templates/:id`

---

## 7.5. Webhooks

* `GET /webhook-sources`
* `POST /webhook-sources`
* `PUT /webhook-sources/:id`
* `DELETE /webhook-sources/:id`

Bindings:

* `GET /webhook-sources/:id/bindings`
* `POST /webhook-sources/:id/bindings`
* `DELETE /webhook-sources/:id/bindings/:bindingId`

Logs:

* `GET /webhook-events` (filtros por source, conta, trade_mode, status)
* `GET /webhook-events/:id`
* `GET /webhook-blocked-attempts` (admin)

Entrada de sinal:

* `POST /webhooks/:code` (p√∫blico, com seguran√ßa de IP/assinatura)

---

## 7.6. Jobs, Execu√ß√µes, Opera√ß√µes

* `GET /trade-jobs`
* `GET /trade-jobs/:id`
* `GET /trade-executions`
* `GET /trade-executions/:id`
* `GET /operations`

  * view combinada de jobs + execu√ß√µes com filtros.

---

## 7.7. POSI√á√ïES

* `GET /positions`

  * filtros:

    * `status`
    * `trade_mode` (`REAL` / `SIMULATION`)
    * `exchange_account_id`
    * `symbol`
    * `from`, `to`
* `GET /positions/:id`

  * inclui fills (`position_fills`), hist√≥rico de SL/TP.
* `PUT /positions/:id/sltp`

  * atualizar SL/TP/trailing da posi√ß√£o (se configur√°vel por posi√ß√£o).
* `PUT /positions/:id/lock-sell-by-webhook`

  * body:

    ```json
    { "lock_sell_by_webhook": true }
    ```
* `POST /positions/:id/close`

  * fechamento manual total ou parcial:

    ```json
    { "quantity": 0.5 } // se omitido, fecha tudo
    ```
  * gera `trade_job` SELL (REAL ou SIMULA√á√ÉO).

* `POST /positions/:id/sell-limit`

  * venda com ordem LIMIT a pre√ßo espec√≠fico:

    ```json
    {
      "limit_price": 220.50,
      "quantity": 2.5,  // opcional, se omitido vende tudo
      "expires_in_hours": 24  // opcional, cancela automaticamente ap√≥s X horas
    }
    ```
  * cria `trade_job` SELL com `order_type=LIMIT` e `status=PENDING_LIMIT`.
  * ordem fica monitorada at√© ser executada ou cancelada.

---

## 7.7.1. Monitoramento de Ordens LIMIT

* `GET /limit-orders`

  * lista todas as ordens LIMIT (compra e venda) do usu√°rio:

    * filtros:

      * `status` (`PENDING_LIMIT`, `FILLED`, `CANCELED`, `EXPIRED`)
      * `side` (`BUY`, `SELL`)
      * `trade_mode` (`REAL`, `SIMULATION`)
      * `exchange_account_id`
      * `symbol`
      * `from`, `to`

  * retorna:

    ```json
    {
      "data": [
        {
          "id": 8955,
          "position_id": 1542,  // null se for compra
          "symbol": "SOL/USDT",
          "side": "SELL",
          "order_type": "LIMIT",
          "limit_price": 220.50,
          "base_quantity": 5.0,
          "status": "PENDING_LIMIT",
          "exchange_order_id": "12345678",
          "created_at": "2025-12-01T16:20:10Z",
          "expires_at": "2025-12-02T16:20:10Z"
        }
      ],
      "pagination": { ... }
    }
    ```

* `GET /limit-orders/:id`

  * detalhes de uma ordem LIMIT espec√≠fica:

    * status atual na exchange (via CCXT `fetchOrder`)
    * hist√≥rico de atualiza√ß√µes
    * fills parciais

* `DELETE /limit-orders/:id`

  * cancela ordem LIMIT pendente:

    * para modo REAL: chama `cancelOrder` via CCXT
    * para modo SIMULATION: marca como `CANCELED`
    * atualiza `trade_job.status = CANCELED`

* `GET /limit-orders/history`

  * hist√≥rico completo de ordens LIMIT:

    * inclui ordens executadas, canceladas e expiradas
    * filtros por per√≠odo, s√≠mbolo, resultado

---

## 7.8. Simula√ß√£o

Atalhos:

* `GET /simulation/positions` ‚Üí `/positions?trade_mode=SIMULATION`
* `GET /simulation/operations` ‚Üí `/operations?trade_mode=SIMULATION`
* `GET /simulation/accounts` ‚Üí contas com `is_simulation = 1`

---

## 7.9. Notifica√ß√µes

* `GET /notifications/config`
* `PUT /notifications/config`
* `GET /notifications/logs` (admin)

---

## 7.10. Endpoints de RELAT√ìRIOS (otimizados)

### 7.10.1. PnL e Performance

* `GET /reports/pnl/summary`

  * Filtros:

    * `trade_mode`
    * `from`, `to`
    * `exchange_account_id` (opcional)
  * Retorna:

    * lucro total
    * preju√≠zo total
    * PnL l√≠quido
    * n√∫mero de trades
    * taxa de acerto

* `GET /reports/pnl/by-symbol`

  * Filtros:

    * `trade_mode`
    * `from`, `to`
  * Retorna array:

    ```json
    [
      { "symbol": "SOL/USDT", "pnl_usd": 123.45, "trades": 34 },
      { "symbol": "BTC/USDT", "pnl_usd": -45.67, "trades": 12 }
    ]
    ```

* `GET /reports/pnl/by-day`

  * Filtros:

    * `trade_mode`
    * `from`, `to`
  * Retorna:

    ```json
    [
      { "date": "2025-11-01", "pnl_usd": 10.5 },
      { "date": "2025-11-02", "pnl_usd": -3.2 }
    ]
    ```

### 7.10.2. Exposi√ß√£o / Posi√ß√µes Abertas

* `GET /reports/open-positions/summary`

  * Agrupa por:

    * `exchange_account_id`
    * `symbol`
  * Retorna:

    * quantidade total aberta
    * valor estimado em USDT (usando pre√ßo atual)
    * PnL n√£o realizado estimado.

### 7.10.3. Cofres

* `GET /reports/vaults/summary`

  * Para cada cofre:

    * saldo total por asset
    * volume movimentado (somat√≥rio DEPOSIT/WITHDRAWAL/SELL_RETURN) no per√≠odo.

### 7.10.4. Webhooks

* `GET /reports/webhooks/summary`

  * Filtros:

    * `webhook_source_id`
    * `from`, `to`
  * Retorna:

    * total de eventos recebidos
    * quantos viraram jobs
    * quantos foram bloqueados (rate limit, IP, assinatura)
    * PnL gerado por source (REAL e SIM separado).

### 7.10.5. Performance por Estrat√©gia

* Se for usado `strategy_code`:

  * `GET /reports/strategy-performance`

    * PnL por `strategy_code`
    * winrate, volume, n√∫mero de trades, etc.

**Implementa√ß√£o de performance**:

* Preferir queries agregadas com √≠ndices espec√≠ficos:

  * `INDEX (trade_mode, created_at)` em `trade_positions` / `trade_executions`.
  * Eventualmente, mais para frente, criar tabelas de **snapshot di√°rio** para PnL.

---

## 7.11. Admin / Sistema

### 7.11.1. Health e M√©tricas

* `GET /admin/health`
  * Status de todos os servi√ßos (API, Executor, Monitors)
  * Conectividade com MySQL, Redis, exchanges
  * Vers√£o da aplica√ß√£o

* `GET /admin/metrics`
  * M√©tricas agregadas do sistema:
    * Total de usu√°rios ativos
    * Total de posi√ß√µes abertas (REAL/SIMULATION)
    * Volume de trades nas √∫ltimas 24h
    * Taxa de sucesso de execu√ß√µes
    * Tempo m√©dio de processamento de webhooks
    * Uso de mem√≥ria/CPU dos workers

### 7.11.2. Gerenciamento de Crons

* `GET /admin/cron/jobs`
  * Lista todos os jobs agendados (BullMQ repeatables):
    * `sl_tp_monitor_real`
    * `sl_tp_monitor_sim`
    * `limit_orders_monitor_real`
    * `limit_orders_monitor_sim`
    * `vault_balance_monitor`
    * `balances_sync_real`
    * `orders_sync_real`
  * Para cada job:
    * Nome, descri√ß√£o
    * Intervalo de execu√ß√£o
    * Status (ACTIVE, PAUSED, DISABLED)
    * √öltima execu√ß√£o (timestamp, dura√ß√£o, resultado)
    * Pr√≥xima execu√ß√£o
    * Total de execu√ß√µes (sucesso/falha)

* `GET /admin/cron/jobs/:name`
  * Detalhes de um job espec√≠fico
  * Hist√≥rico das √∫ltimas 100 execu√ß√µes
  * Logs de erros
  * Configura√ß√£o de intervalo

* `PUT /admin/cron/jobs/:name`
  * Atualizar configura√ß√£o do job:
    * Alterar intervalo
    * Ativar/desativar
    * Ajustar timeout

* `POST /admin/cron/jobs/:name/run`
  * Executar job manualmente (fora do agendamento)
  * √ötil para testes ou corre√ß√µes emergenciais

* `POST /admin/cron/jobs/:name/pause`
  * Pausar job temporariamente

* `POST /admin/cron/jobs/:name/resume`
  * Retomar job pausado

* `GET /admin/cron/history`
  * Hist√≥rico completo de execu√ß√µes de todos os jobs
  * Filtros: job_name, status, data
  * Estat√≠sticas: m√©dia de dura√ß√£o, taxa de erro

### 7.11.3. Auditoria e Logs

* `GET /admin/audit-logs`
  * Logs de auditoria de a√ß√µes de usu√°rios:
    * Filtros:
      * `user_id`
      * `entity_type` (USER, POSITION, WEBHOOK_SOURCE, etc.)
      * `action` (CREATE, UPDATE, DELETE, etc.)
      * `from`, `to` (per√≠odo)
    * Pagina√ß√£o
    * Export CSV/JSON

* `GET /admin/audit-logs/:id`
  * Detalhes de um log espec√≠fico
  * Diff completo das mudan√ßas (changes_json)
  * Contexto da requisi√ß√£o

* `GET /admin/system-audit-logs`
  * Logs de eventos do sistema:
    * Filtros:
      * `service` (API, EXECUTOR, MONITORS)
      * `event_type`
      * `severity` (INFO, WARNING, ERROR, CRITICAL)
      * `from`, `to`
    * Alertas cr√≠ticos destacados

* `GET /admin/logs/errors`
  * Logs de erros consolidados
  * Agrupados por tipo/mensagem
  * Frequ√™ncia de ocorr√™ncia
  * Stack traces

* `GET /admin/logs/webhooks`
  * Logs espec√≠ficos de webhooks recebidos:
    * Eventos bem-sucedidos
    * Tentativas bloqueadas (IP, assinatura)
    * Rate limiting
    * Parsing errors

* `POST /admin/audit-logs/export`
  * Exportar logs de auditoria para an√°lise:
    * Formatos: CSV, JSON, Excel
    * Filtros aplic√°veis
    * Envio por email ou download direto

### 7.11.4. Configura√ß√µes do Sistema

* `GET /admin/settings`
  * Todas as configura√ß√µes globais do sistema:
    * Rate limits
    * Timeouts de execu√ß√£o
    * Configura√ß√µes de exchanges
    * Par√¢metros de seguran√ßa

* `PUT /admin/settings`
  * Atualizar configura√ß√µes (requer admin)
  * Valida√ß√£o rigorosa
  * Log de auditoria para toda altera√ß√£o

* `GET /admin/feature-flags`
  * Feature flags do sistema:
    * Habilitar/desabilitar funcionalidades
    * Rollout gradual
    * A/B testing

* `PUT /admin/feature-flags/:key`
  * Ativar/desativar feature flag espec√≠fica

---

## 7.12. Documenta√ß√£o OpenAPI (Swagger)

### 7.12.1. Endpoints de Documenta√ß√£o

* **`GET /api-docs`**
  
  * Interface Swagger UI interativa
  * Permite testar endpoints diretamente no navegador
  * Suporta autentica√ß√£o JWT via bot√£o "Authorize"
  * Agrupamento por dom√≠nios (Auth, Accounts, Vaults, Positions, etc.)

* **`GET /api-docs/json`**
  
  * Retorna especifica√ß√£o OpenAPI 3.0 completa em JSON
  * Permite download direto do schema
  * √ötil para gera√ß√£o de clients (TypeScript, Python, etc.)

* **`GET /api-docs/yaml`**
  
  * Retorna especifica√ß√£o OpenAPI 3.0 em YAML
  * Alternativa para ferramentas que preferem YAML

### 7.12.2. Estrutura da Documenta√ß√£o OpenAPI

**Metadados Globais:**

```yaml
openapi: 3.0.0
info:
  title: Trading Automation API
  version: 1.0.0
  description: |
    API de automa√ß√£o de trading para exchanges com suporte a:
    - Execu√ß√£o autom√°tica via webhooks
    - Gerenciamento de posi√ß√µes independentes (FIFO)
    - Cofres virtuais para controle de capital
    - Modo real e simula√ß√£o
    - SL/TP/Trailing autom√°tico
  contact:
    name: API Support
    email: support@tradingautomation.com
  license:
    name: Proprietary
servers:
  - url: https://api.tradingautomation.com/v1
    description: Produ√ß√£o
  - url: https://staging-api.tradingautomation.com/v1
    description: Staging
  - url: http://localhost:3000/v1
    description: Desenvolvimento Local
```

**Esquemas de Seguran√ßa:**

```yaml
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtido via POST /auth/login.
        Incluir no header: Authorization: Bearer {token}
    
security:
  - bearerAuth: []  # Aplicado globalmente (exceto endpoints p√∫blicos)
```

**Tags e Agrupamentos:**

```yaml
tags:
  - name: Auth
    description: Autentica√ß√£o e gerenciamento de usu√°rios
  - name: Exchange Accounts
    description: Contas de exchange (real e simula√ß√£o)
  - name: Vaults
    description: Cofres virtuais para gest√£o de capital
  - name: Trade Parameters
    description: Configura√ß√£o de par√¢metros de trading
  - name: Webhooks
    description: Fontes de webhook e eventos
  - name: Positions
    description: Posi√ß√µes abertas e fechadas
  - name: Jobs & Executions
    description: Jobs de trading e execu√ß√µes
  - name: Reports
    description: Relat√≥rios de PnL, performance e exposi√ß√£o
  - name: Notifications
    description: Configura√ß√£o de notifica√ß√µes WhatsApp
  - name: Admin
    description: Administra√ß√£o e monitoramento do sistema
  - name: Audit
    description: Logs de auditoria e rastreamento de a√ß√µes
  - name: Cron Management
    description: Gerenciamento de jobs agendados
```

### 7.12.3. Exemplos de Documenta√ß√£o por Endpoint

#### Auth - Login

```yaml
paths:
  /auth/login:
    post:
      tags:
        - Auth
      summary: Autentica√ß√£o de usu√°rio
      description: |
        Realiza login com email e senha. Retorna access token JWT e refresh token.
        Se 2FA estiver habilitado, retorna `requires_2fa: true` e requer chamada adicional.
      operationId: login
      security: []  # Endpoint p√∫blico
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: "SecureP@ssw0rd"
            examples:
              loginSimples:
                summary: Login sem 2FA
                value:
                  email: trader@example.com
                  password: MySecurePassword123
              loginCom2FA:
                summary: Login com 2FA habilitado
                value:
                  email: admin@example.com
                  password: AdminPass456
      responses:
        '200':
          description: Login bem-sucedido
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/LoginSuccessResponse'
                  - $ref: '#/components/schemas/Login2FARequiredResponse'
              examples:
                successSem2FA:
                  summary: Sucesso sem 2FA
                  value:
                    access_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    refresh_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    expires_in: 3600
                    user:
                      id: 123
                      email: trader@example.com
                      full_name: Jo√£o Trader
                successCom2FA:
                  summary: Requer verifica√ß√£o 2FA
                  value:
                    requires_2fa: true
                    session_token: temp_session_abc123xyz
                    message: "Por favor, forne√ßa o c√≥digo 2FA"
        '401':
          description: Credenciais inv√°lidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Unauthorized
                message: Email ou senha incorretos
                statusCode: 401
        '429':
          description: Muitas tentativas de login
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Too Many Requests
                message: Muitas tentativas. Tente novamente em 15 minutos
                statusCode: 429
                retry_after: 900
```

#### Positions - Listar Posi√ß√µes

```yaml
  /positions:
    get:
      tags:
        - Positions
      summary: Listar posi√ß√µes
      description: |
        Lista todas as posi√ß√µes do usu√°rio com filtros opcionais.
        Posi√ß√µes s√£o independentes (1 compra = 1 posi√ß√£o).
        Suporta pagina√ß√£o e ordena√ß√£o.
      operationId: listPositions
      parameters:
        - name: status
          in: query
          description: Filtrar por status da posi√ß√£o
          schema:
            type: string
            enum: [OPEN, CLOSED]
          example: OPEN
        - name: trade_mode
          in: query
          description: Modo de trading
          schema:
            type: string
            enum: [REAL, SIMULATION]
          example: REAL
        - name: exchange_account_id
          in: query
          description: ID da conta de exchange
          schema:
            type: integer
          example: 5
        - name: symbol
          in: query
          description: S√≠mbolo do ativo (formato CCXT)
          schema:
            type: string
          example: SOL/USDT
        - name: from
          in: query
          description: Data inicial (ISO 8601)
          schema:
            type: string
            format: date-time
          example: "2025-11-01T00:00:00Z"
        - name: to
          in: query
          description: Data final (ISO 8601)
          schema:
            type: string
            format: date-time
          example: "2025-12-01T23:59:59Z"
        - name: page
          in: query
          description: N√∫mero da p√°gina (come√ßa em 1)
          schema:
            type: integer
            minimum: 1
            default: 1
          example: 1
        - name: limit
          in: query
          description: Itens por p√°gina
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
        - name: sort
          in: query
          description: Campo de ordena√ß√£o
          schema:
            type: string
            enum: [created_at, closed_at, realized_profit_usd]
            default: created_at
          example: created_at
        - name: order
          in: query
          description: Dire√ß√£o da ordena√ß√£o
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          example: desc
      responses:
        '200':
          description: Lista de posi√ß√µes
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Position'
                  pagination:
                    $ref: '#/components/schemas/PaginationMeta'
              examples:
                posicoesAbertas:
                  summary: Posi√ß√µes abertas em modo real
                  value:
                    data:
                      - id: 1542
                        exchange_account_id: 5
                        trade_mode: REAL
                        symbol: SOL/USDT
                        side: LONG
                        trade_job_id_open: 8921
                        qty_total: 5.0
                        qty_remaining: 5.0
                        price_open: 213.45
                        status: OPEN
                        realized_profit_usd: 0.0
                        unrealized_pnl_usd: 12.75
                        current_price: 215.00
                        sl_enabled: true
                        sl_pct: 2.0
                        tp_enabled: true
                        tp_pct: 5.0
                        trailing_enabled: false
                        lock_sell_by_webhook: false
                        created_at: "2025-12-01T14:32:15Z"
                        updated_at: "2025-12-01T14:32:15Z"
                      - id: 1543
                        exchange_account_id: 5
                        trade_mode: REAL
                        symbol: BTC/USDT
                        side: LONG
                        trade_job_id_open: 8923
                        qty_total: 0.025
                        qty_remaining: 0.025
                        price_open: 98450.00
                        status: OPEN
                        realized_profit_usd: 0.0
                        unrealized_pnl_usd: -25.50
                        current_price: 98000.00
                        sl_enabled: true
                        sl_pct: 1.5
                        tp_enabled: true
                        tp_pct: 3.0
                        trailing_enabled: true
                        trailing_distance_pct: 1.0
                        trailing_max_price: 98500.00
                        lock_sell_by_webhook: true
                        created_at: "2025-12-01T15:10:42Z"
                        updated_at: "2025-12-01T15:45:30Z"
                    pagination:
                      current_page: 1
                      per_page: 20
                      total_items: 2
                      total_pages: 1
        '400':
          description: Par√¢metros inv√°lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: N√£o autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
```

#### Positions - Fechar Posi√ß√£o

```yaml
  /positions/{id}/close:
    post:
      tags:
        - Positions
      summary: Fechar posi√ß√£o (total ou parcial)
      description: |
        Cria um job de venda para fechar a posi√ß√£o.
        Se `quantity` n√£o for informado, fecha toda a posi√ß√£o (qty_remaining).
        Para fechamento parcial, especifique a quantidade desejada.
      operationId: closePosition
      parameters:
        - name: id
          in: path
          required: true
          description: ID da posi√ß√£o
          schema:
            type: integer
          example: 1542
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                quantity:
                  type: number
                  format: double
                  description: Quantidade a fechar (omitir para fechar tudo)
                  example: 2.5
                order_type:
                  type: string
                  enum: [MARKET, LIMIT]
                  default: MARKET
                  description: Tipo de ordem
                limit_price:
                  type: number
                  format: double
                  description: Pre√ßo limite (obrigat√≥rio se order_type=LIMIT)
                  example: 216.00
            examples:
              fechamentoTotal:
                summary: Fechar posi√ß√£o completa
                value: {}
              fechamentoParcial:
                summary: Fechar 50% da posi√ß√£o
                value:
                  quantity: 2.5
              fechamentoComLimit:
                summary: Fechar com ordem LIMIT
                value:
                  quantity: 5.0
                  order_type: LIMIT
                  limit_price: 220.00
      responses:
        '201':
          description: Job de fechamento criado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  trade_job:
                    $ref: '#/components/schemas/TradeJob'
              example:
                message: Job de venda criado com sucesso
                trade_job:
                  id: 8955
                  exchange_account_id: 5
                  trade_mode: REAL
                  symbol: SOL/USDT
                  side: SELL
                  order_type: MARKET
                  base_quantity: 5.0
                  status: PENDING
                  created_at: "2025-12-01T16:20:10Z"
        '400':
          description: Requisi√ß√£o inv√°lida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                quantityInvalida:
                  summary: Quantidade maior que dispon√≠vel
                  value:
                    error: Bad Request
                    message: Quantidade solicitada (10.0) maior que qty_remaining (5.0)
                    statusCode: 400
                limitPriceObrigatorio:
                  summary: Pre√ßo limite n√£o informado
                  value:
                    error: Bad Request
                    message: limit_price √© obrigat√≥rio quando order_type=LIMIT
                    statusCode: 400
        '404':
          description: Posi√ß√£o n√£o encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
```

#### Positions - Venda com Ordem LIMIT

```yaml
  /positions/{id}/sell-limit:
    post:
      tags:
        - Positions
      summary: Vender posi√ß√£o com ordem LIMIT
      description: |
        Cria uma ordem de venda LIMIT a pre√ßo espec√≠fico para a posi√ß√£o.
        A ordem fica pendente at√©:
        - Ser executada quando o pre√ßo for atingido
        - Ser cancelada manualmente
        - Expirar (se expires_in_hours for definido)
        
        **Diferen√ßa do /close:**
        - `/close`: cria ordem MARKET (execu√ß√£o imediata)
        - `/sell-limit`: cria ordem LIMIT (executa quando pre√ßo atingir o valor)
      operationId: sellPositionLimit
      parameters:
        - name: id
          in: path
          required: true
          description: ID da posi√ß√£o
          schema:
            type: integer
          example: 1542
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - limit_price
              properties:
                limit_price:
                  type: number
                  format: double
                  description: Pre√ßo de venda desejado
                  example: 220.50
                quantity:
                  type: number
                  format: double
                  description: Quantidade a vender (omitir para vender tudo)
                  example: 2.5
                expires_in_hours:
                  type: integer
                  description: Cancelar automaticamente ap√≥s X horas
                  minimum: 1
                  maximum: 720
                  example: 24
            examples:
              vendaTotal:
                summary: Vender posi√ß√£o completa a R$ 220.50
                value:
                  limit_price: 220.50
              vendaParcialComExpiracao:
                summary: Vender 50% com expira√ß√£o em 48h
                value:
                  limit_price: 225.00
                  quantity: 2.5
                  expires_in_hours: 48
      responses:
        '201':
          description: Ordem LIMIT criada com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  trade_job:
                    $ref: '#/components/schemas/TradeJob'
                  limit_order:
                    type: object
                    properties:
                      exchange_order_id:
                        type: string
                        description: ID da ordem na exchange
                      status:
                        type: string
                        example: PENDING_LIMIT
                      monitor_url:
                        type: string
                        description: URL para monitorar status da ordem
              example:
                message: Ordem LIMIT de venda criada com sucesso
                trade_job:
                  id: 8956
                  exchange_account_id: 5
                  trade_mode: REAL
                  symbol: SOL/USDT
                  side: SELL
                  order_type: LIMIT
                  limit_price: 220.50
                  base_quantity: 5.0
                  status: PENDING_LIMIT
                  limit_order_expires_at: "2025-12-02T16:20:10Z"
                  created_at: "2025-12-01T16:20:10Z"
                limit_order:
                  exchange_order_id: "987654321"
                  status: PENDING_LIMIT
                  monitor_url: "/limit-orders/8956"
        '400':
          description: Requisi√ß√£o inv√°lida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                preco_invalido:
                  summary: Pre√ßo abaixo do m√≠nimo
                  value:
                    error: Bad Request
                    message: "limit_price (150.00) est√° muito abaixo do pre√ßo atual (213.00). Diferen√ßa m√°xima: 5%"
                    statusCode: 400
                posicao_ja_tem_ordem:
                  summary: Posi√ß√£o j√° tem ordem LIMIT pendente
                  value:
                    error: Bad Request
                    message: "Posi√ß√£o j√° possui ordem LIMIT pendente (job_id: 8950). Cancele-a antes de criar nova."
                    statusCode: 400
        '404':
          description: Posi√ß√£o n√£o encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
```

#### Limit Orders - Listar Ordens Pendentes

```yaml
  /limit-orders:
    get:
      tags:
        - Limit Orders
      summary: Listar ordens LIMIT
      description: |
        Lista todas as ordens LIMIT (compra e venda) do usu√°rio.
        √ötil para monitorar ordens pendentes e hist√≥rico.
      operationId: listLimitOrders
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [PENDING_LIMIT, FILLED, CANCELED, EXPIRED]
          example: PENDING_LIMIT
        - name: side
          in: query
          schema:
            type: string
            enum: [BUY, SELL]
          example: SELL
        - name: trade_mode
          in: query
          schema:
            type: string
            enum: [REAL, SIMULATION]
          example: REAL
        - name: symbol
          in: query
          schema:
            type: string
          example: SOL/USDT
      responses:
        '200':
          description: Lista de ordens LIMIT
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/LimitOrder'
                  pagination:
                    $ref: '#/components/schemas/PaginationMeta'
              example:
                data:
                  - id: 8956
                    position_id: 1542
                    symbol: SOL/USDT
                    side: SELL
                    order_type: LIMIT
                    limit_price: 220.50
                    base_quantity: 5.0
                    status: PENDING_LIMIT
                    exchange_order_id: "987654321"
                    current_price: 215.30
                    distance_pct: 2.41
                    created_at: "2025-12-01T16:20:10Z"
                    expires_at: "2025-12-02T16:20:10Z"
                  - id: 8952
                    position_id: 1540
                    symbol: BTC/USDT
                    side: SELL
                    order_type: LIMIT
                    limit_price: 101000.00
                    base_quantity: 0.05
                    status: PENDING_LIMIT
                    exchange_order_id: "987654320"
                    current_price: 98500.00
                    distance_pct: 2.54
                    created_at: "2025-12-01T10:15:30Z"
                    expires_at: null
                pagination:
                  current_page: 1
                  per_page: 20
                  total_items: 2
                  total_pages: 1
```

```yaml
  /limit-orders/{id}:
    get:
      tags:
        - Limit Orders
      summary: Detalhes de ordem LIMIT
      description: Retorna status atualizado e hist√≥rico de uma ordem LIMIT
      operationId: getLimitOrder
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Detalhes da ordem
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LimitOrderDetail'
    
    delete:
      tags:
        - Limit Orders
      summary: Cancelar ordem LIMIT
      description: |
        Cancela uma ordem LIMIT pendente.
        - Modo REAL: cancela na exchange via CCXT
        - Modo SIMULATION: apenas marca como cancelada
      operationId: cancelLimitOrder
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Ordem cancelada
          content:
            application/json:
              example:
                message: Ordem LIMIT cancelada com sucesso
                order_id: 8956
                exchange_order_id: "987654321"
        '400':
          description: Ordem n√£o pode ser cancelada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Bad Request
                message: Ordem j√° foi executada e n√£o pode ser cancelada
                statusCode: 400
```

#### Webhooks - Receber Sinal

```yaml
  /webhooks/{code}:
    post:
      tags:
        - Webhooks
      summary: Receber sinal de trading
      description: |
        Endpoint p√∫blico para recep√ß√£o de sinais via webhook (TradingView, etc).
        
        **Seguran√ßa:**
        - Valida√ß√£o de IP contra lista permitida (CIDR)
        - Assinatura HMAC-SHA256 opcional via header X-Signature
        - Rate limiting configur√°vel por fonte
        - Idempot√™ncia via event_uid
        
        **Processamento:**
        1. Valida IP e assinatura
        2. Parseia payload e extrai informa√ß√µes do sinal
        3. Cria webhook_event com status RECEIVED
        4. Enfileira jobs para contas vinculadas
        5. Retorna 200 imediatamente (processamento ass√≠ncrono)
      operationId: receiveWebhook
      security: []  # Endpoint p√∫blico (seguran√ßa via IP + assinatura)
      parameters:
        - name: code
          in: path
          required: true
          description: C√≥digo √∫nico do webhook source
          schema:
            type: string
          example: my-tradingview-alerts
        - name: X-Signature
          in: header
          required: false
          description: Assinatura HMAC-SHA256 do body (se require_signature=true)
          schema:
            type: string
          example: sha256=a3f5b8c9d2e1f4a7b6c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Payload flex√≠vel - ser√° parseado conforme regras configuradas
              additionalProperties: true
            examples:
              sinalCompra:
                summary: Sinal de compra (Ca√ßa Fundo)
                value:
                  text: "SOLUSDT.P Ca√ßa Fundo üü¢ (H1) Pre√ßo (213.09)"
                  exchange: BINANCE
                  ticker: SOLUSDT
                  interval: 1h
                  time: "2025-12-01T14:30:00Z"
              sinalVenda:
                summary: Sinal de venda (Ca√ßa Topo)
                value:
                  text: "BTCUSDT.P Ca√ßa Topo üî¥ (H4) Pre√ßo (98450.50)"
                  exchange: BINANCE
                  ticker: BTCUSDT
                  interval: 4h
                  time: "2025-12-01T15:00:00Z"
              sinalCustomizado:
                summary: Payload customizado
                value:
                  strategy: mean_reversion
                  symbol: ETH/USDT
                  action: BUY
                  price: 3850.25
                  timeframe: 15m
                  confidence: 0.85
          text/plain:
            schema:
              type: string
            example: "SOLUSDT.P Ca√ßa Fundo üü¢ (H1) Pre√ßo (213.09)"
      responses:
        '200':
          description: Webhook recebido e enfileirado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  event_id:
                    type: integer
                  event_uid:
                    type: string
                  accounts_triggered:
                    type: integer
                    description: N√∫mero de contas que receber√£o o sinal
              example:
                message: Webhook recebido com sucesso
                event_id: 45231
                event_uid: "evt_20251201_solusdt_h1_21309"
                accounts_triggered: 3
        '400':
          description: Payload inv√°lido ou parsing falhou
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Bad Request
                message: "N√£o foi poss√≠vel extrair s√≠mbolo do payload"
                statusCode: 400
        '403':
          description: Acesso negado (IP n√£o autorizado ou assinatura inv√°lida)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                ipBloqueado:
                  summary: IP n√£o est√° na lista permitida
                  value:
                    error: Forbidden
                    message: IP 203.0.113.45 n√£o autorizado para este webhook
                    statusCode: 403
                assinaturaInvalida:
                  summary: Assinatura HMAC incorreta
                  value:
                    error: Forbidden
                    message: Assinatura inv√°lida ou ausente
                    statusCode: 403
        '404':
          description: Webhook code n√£o encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit excedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Too Many Requests
                message: Rate limit de 60 requisi√ß√µes/min excedido
                statusCode: 429
                retry_after: 45
```

### 7.12.4. Schemas Comuns

```yaml
components:
  schemas:
    ErrorResponse:
      type: object
      required:
        - error
        - message
        - statusCode
      properties:
        error:
          type: string
          example: Bad Request
        message:
          type: string
          example: Descri√ß√£o detalhada do erro
        statusCode:
          type: integer
          example: 400
        details:
          type: object
          description: Detalhes adicionais (valida√ß√£o, campos, etc)
          additionalProperties: true
    
    PaginationMeta:
      type: object
      properties:
        current_page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 20
        total_items:
          type: integer
          example: 156
        total_pages:
          type: integer
          example: 8
    
    Position:
      type: object
      required:
        - id
        - exchange_account_id
        - trade_mode
        - symbol
        - side
        - qty_total
        - qty_remaining
        - price_open
        - status
      properties:
        id:
          type: integer
          description: ID √∫nico da posi√ß√£o
        exchange_account_id:
          type: integer
          description: ID da conta de exchange
        trade_mode:
          type: string
          enum: [REAL, SIMULATION]
        symbol:
          type: string
          description: S√≠mbolo no formato CCXT (ex SOL/USDT)
        side:
          type: string
          enum: [LONG]
          description: Lado da posi√ß√£o (futuro SHORT para futuros)
        trade_job_id_open:
          type: integer
          description: ID do job que criou a posi√ß√£o
        qty_total:
          type: number
          format: double
          description: Quantidade total comprada
        qty_remaining:
          type: number
          format: double
          description: Quantidade ainda aberta
        price_open:
          type: number
          format: double
          description: Pre√ßo de compra
        status:
          type: string
          enum: [OPEN, CLOSED]
        realized_profit_usd:
          type: number
          format: double
          description: Lucro realizado em vendas
        unrealized_pnl_usd:
          type: number
          format: double
          description: PnL n√£o realizado (calculado em tempo real)
          readOnly: true
        current_price:
          type: number
          format: double
          description: Pre√ßo atual do ativo
          readOnly: true
        sl_enabled:
          type: boolean
        sl_pct:
          type: number
          format: double
        tp_enabled:
          type: boolean
        tp_pct:
          type: number
          format: double
        trailing_enabled:
          type: boolean
        trailing_distance_pct:
          type: number
          format: double
        trailing_max_price:
          type: number
          format: double
        lock_sell_by_webhook:
          type: boolean
          description: Se true, n√£o ser√° vendida por sinais de webhook
        close_reason:
          type: string
          enum: [TARGET_HIT, STOP_LOSS, MANUAL, WEBHOOK_SELL, RECONCILIATION]
          nullable: true
        closed_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    TradeJob:
      type: object
      properties:
        id:
          type: integer
        webhook_event_id:
          type: integer
          nullable: true
        exchange_account_id:
          type: integer
        trade_mode:
          type: string
          enum: [REAL, SIMULATION]
        symbol:
          type: string
        side:
          type: string
          enum: [BUY, SELL]
        order_type:
          type: string
          enum: [MARKET, LIMIT, STOP_LIMIT]
        quote_amount:
          type: number
          format: double
          description: Valor em USDT (para BUY)
        base_quantity:
          type: number
          format: double
          description: Quantidade base (SOL, BTC, etc)
        limit_price:
          type: number
          format: double
          nullable: true
        status:
          type: string
          enum: [PENDING, EXECUTING, FILLED, PARTIALLY_FILLED, FAILED, SKIPPED, CANCELED, PENDING_LIMIT]
        reason_code:
          type: string
          nullable: true
        reason_message:
          type: string
          nullable: true
        vault_id:
          type: integer
          nullable: true
        limit_order_expires_at:
          type: string
          format: date-time
          nullable: true
          description: Data de expira√ß√£o para ordens LIMIT
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    LimitOrder:
      type: object
      description: Ordem LIMIT pendente ou hist√≥rica
      properties:
        id:
          type: integer
          description: ID do trade_job
        position_id:
          type: integer
          nullable: true
          description: ID da posi√ß√£o (null para compras)
        symbol:
          type: string
          example: SOL/USDT
        side:
          type: string
          enum: [BUY, SELL]
        order_type:
          type: string
          enum: [LIMIT]
        limit_price:
          type: number
          format: double
          description: Pre√ßo limite da ordem
        base_quantity:
          type: number
          format: double
          description: Quantidade a ser negociada
        status:
          type: string
          enum: [PENDING_LIMIT, FILLED, CANCELED, EXPIRED]
        exchange_order_id:
          type: string
          description: ID da ordem na exchange
        current_price:
          type: number
          format: double
          description: Pre√ßo atual do ativo
          readOnly: true
        distance_pct:
          type: number
          format: double
          description: Dist√¢ncia percentual do pre√ßo atual at√© limit_price
          readOnly: true
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: Data de expira√ß√£o autom√°tica
    
    LimitOrderDetail:
      allOf:
        - $ref: '#/components/schemas/LimitOrder'
        - type: object
          properties:
            position:
              $ref: '#/components/schemas/Position'
              nullable: true
            executions:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: integer
                  executed_qty:
                    type: number
                  avg_price:
                    type: number
                  created_at:
                    type: string
                    format: date-time
            status_updates:
              type: array
              description: Hist√≥rico de mudan√ßas de status
              items:
                type: object
                properties:
                  from_status:
                    type: string
                  to_status:
                    type: string
                  timestamp:
                    type: string
                    format: date-time
                  reason:
                    type: string
```

### 7.12.5. Implementa√ß√£o T√©cnica (NestJS)

**Setup e Configura√ß√£o:**

1. Instalar depend√™ncias:
   ```bash
   pnpm add @nestjs/swagger swagger-ui-express
   ```

2. Configurar no `main.ts`:
   ```typescript
   import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
   
   const config = new DocumentBuilder()
     .setTitle('Trading Automation API')
     .setDescription('API de automa√ß√£o de trading...')
     .setVersion('1.0.0')
     .addBearerAuth()
     .addTag('Auth', 'Autentica√ß√£o e gerenciamento de usu√°rios')
     .addTag('Positions', 'Posi√ß√µes abertas e fechadas')
     // ... outras tags
     .addServer('https://api.tradingautomation.com/v1', 'Produ√ß√£o')
     .addServer('http://localhost:3000/v1', 'Desenvolvimento')
     .build();
   
   const document = SwaggerModule.createDocument(app, config);
   
   // UI interativa
   SwaggerModule.setup('api-docs', app, document, {
     swaggerOptions: {
       persistAuthorization: true,
       docExpansion: 'none',
       filter: true,
       showRequestDuration: true,
     },
   });
   
   // Export JSON
   app.use('/api-docs/json', (req, res) => {
     res.setHeader('Content-Type', 'application/json');
     res.setHeader('Content-Disposition', 'attachment; filename=openapi.json');
     res.send(document);
   });
   ```

3. Decorators nos Controllers:
   ```typescript
   @ApiTags('Positions')
   @ApiBearerAuth()
   @Controller('positions')
   export class PositionsController {
     
     @Get()
     @ApiOperation({ 
       summary: 'Listar posi√ß√µes',
       description: 'Lista todas as posi√ß√µes do usu√°rio...'
     })
     @ApiQuery({ name: 'status', enum: ['OPEN', 'CLOSED'], required: false })
     @ApiQuery({ name: 'trade_mode', enum: ['REAL', 'SIMULATION'], required: false })
     @ApiResponse({
       status: 200,
       description: 'Lista de posi√ß√µes',
       type: [PositionDto],
     })
     @ApiResponse({ status: 401, description: 'N√£o autenticado' })
     async list(@Query() filters: ListPositionsDto) {
       // ...
     }
     
     @Post(':id/close')
     @ApiOperation({ summary: 'Fechar posi√ß√£o' })
     @ApiParam({ name: 'id', type: 'integer', example: 1542 })
     @ApiBody({ type: ClosePositionDto, required: false })
     @ApiResponse({ status: 201, description: 'Job criado' })
     async close(@Param('id') id: number, @Body() dto?: ClosePositionDto) {
       // ...
     }
   }
   ```

4. DTOs com decorators de valida√ß√£o e documenta√ß√£o:
   ```typescript
   import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
   
   export class PositionDto {
     @ApiProperty({ example: 1542 })
     id: number;
     
     @ApiProperty({ enum: ['REAL', 'SIMULATION'] })
     trade_mode: string;
     
     @ApiProperty({ example: 'SOL/USDT' })
     symbol: string;
     
     @ApiPropertyOptional({ example: 213.45 })
     price_open?: number;
     
     // ... outros campos
   }
   ```

### 7.12.6. Recursos Adicionais

**Exemplos de uso com cURL:**

```bash
# Login
curl -X POST https://api.tradingautomation.com/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"senha123"}'

# Listar posi√ß√µes abertas
curl -X GET "https://api.tradingautomation.com/v1/positions?status=OPEN&trade_mode=REAL" \
  -H "Authorization: Bearer eyJhbGc..."

# Fechar posi√ß√£o
curl -X POST https://api.tradingautomation.com/v1/positions/1542/close \
  -H "Authorization: Bearer eyJhbGc..." \
  -H "Content-Type: application/json" \
  -d '{"quantity":2.5}'

# Receber webhook
curl -X POST https://api.tradingautomation.com/v1/webhooks/my-alerts \
  -H "Content-Type: application/json" \
  -H "X-Signature: sha256=a3f5b..." \
  -d '{"text":"SOLUSDT.P Ca√ßa Fundo üü¢ (H1) Pre√ßo (213.09)"}'
```

**Download do schema:**

```bash
# JSON
curl https://api.tradingautomation.com/v1/api-docs/json -o openapi.json

# Gerar client TypeScript
npx openapi-typescript openapi.json --output src/api-types.ts
```

### 7.12.7. Exemplos Adicionais de Endpoints Admin

#### Admin - Listar Usu√°rios

```yaml
  /admin/users:
    get:
      tags:
        - Admin
      summary: Listar todos os usu√°rios
      description: |
        Lista usu√°rios do sistema com filtros e estat√≠sticas.
        Requer role ADMIN.
      operationId: adminListUsers
      parameters:
        - name: role
          in: query
          schema:
            type: string
            enum: [admin, user]
        - name: is_active
          in: query
          schema:
            type: boolean
        - name: email
          in: query
          description: Busca por email (parcial)
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Lista de usu√°rios
          content:
            application/json:
              example:
                data:
                  - id: 1
                    email: admin@example.com
                    full_name: Admin Master
                    role: admin
                    is_active: true
                    last_login_at: "2025-12-01T10:30:00Z"
                    stats:
                      exchange_accounts: 3
                      open_positions: 5
                      total_trades: 142
                    created_at: "2024-01-15T08:00:00Z"
                  - id: 2
                    email: trader@example.com
                    full_name: Jo√£o Trader
                    role: user
                    is_active: true
                    last_login_at: "2025-12-02T09:15:00Z"
                    stats:
                      exchange_accounts: 1
                      open_positions: 2
                      total_trades: 45
                    created_at: "2024-03-20T14:30:00Z"
                pagination:
                  current_page: 1
                  per_page: 20
                  total_items: 2
                  total_pages: 1
    
    post:
      tags:
        - Admin
      summary: Criar novo usu√°rio
      description: Cria usu√°rio com senha tempor√°ria e for√ßa troca no primeiro login
      operationId: adminCreateUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - full_name
              properties:
                email:
                  type: string
                  format: email
                full_name:
                  type: string
                role:
                  type: string
                  enum: [admin, user]
                  default: user
                phone:
                  type: string
                whatsapp_phone:
                  type: string
                send_welcome_notification:
                  type: boolean
                  default: true
            example:
              email: newtrader@example.com
              full_name: Maria Trader
              role: user
              phone: "+5511999999999"
              whatsapp_phone: "+5511999999999"
      responses:
        '201':
          description: Usu√°rio criado
          content:
            application/json:
              example:
                message: Usu√°rio criado com sucesso
                user:
                  id: 3
                  email: newtrader@example.com
                  full_name: Maria Trader
                  role: user
                  is_active: true
                  must_change_password: true
                temporary_password: "TempP@ss2025"
                notification_sent: true
```

#### Admin - Reset de Senha

```yaml
  /admin/users/{id}/reset-password:
    post:
      tags:
        - Admin
      summary: Resetar senha do usu√°rio
      description: |
        Gera nova senha tempor√°ria e for√ßa troca no pr√≥ximo login.
        Notifica usu√°rio via email/WhatsApp.
      operationId: adminResetPassword
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                send_notification:
                  type: boolean
                  default: true
                notification_method:
                  type: string
                  enum: [email, whatsapp, both]
                  default: both
      responses:
        '200':
          description: Senha resetada
          content:
            application/json:
              example:
                message: Senha resetada com sucesso
                temporary_password: "NewTemp@2025"
                notification_sent: true
                must_change_password: true
```

#### Cron Management - Listar Jobs

```yaml
  /admin/cron/jobs:
    get:
      tags:
        - Cron Management
      summary: Listar jobs agendados
      description: Retorna status e estat√≠sticas de todos os crons
      operationId: listCronJobs
      responses:
        '200':
          description: Lista de jobs
          content:
            application/json:
              example:
                data:
                  - name: sl_tp_monitor_real
                    description: Monitor de SL/TP para modo REAL
                    interval: "*/30 * * * * *"  # A cada 30 segundos
                    status: ACTIVE
                    last_execution:
                      timestamp: "2025-12-02T10:45:30Z"
                      duration_ms: 1250
                      result: SUCCESS
                      positions_checked: 45
                    next_execution: "2025-12-02T10:46:00Z"
                    statistics:
                      total_runs: 2880
                      success: 2875
                      failures: 5
                      avg_duration_ms: 1180
                  - name: limit_orders_monitor_real
                    description: Monitor de ordens LIMIT pendentes (REAL)
                    interval: "0 * * * * *"  # A cada minuto
                    status: ACTIVE
                    last_execution:
                      timestamp: "2025-12-02T10:45:00Z"
                      duration_ms: 850
                      result: SUCCESS
                      orders_checked: 12
                      orders_filled: 2
                    next_execution: "2025-12-02T10:46:00Z"
                    statistics:
                      total_runs: 1440
                      success: 1438
                      failures: 2
                      avg_duration_ms: 920
                  - name: balances_sync_real
                    description: Sincroniza√ß√£o de saldos com exchanges
                    interval: "0 */5 * * * *"  # A cada 5 minutos
                    status: PAUSED
                    last_execution:
                      timestamp: "2025-12-02T10:40:00Z"
                      duration_ms: 3200
                      result: ERROR
                      error: "Timeout na Binance API"
                    next_execution: null
                    statistics:
                      total_runs: 288
                      success: 285
                      failures: 3
                      avg_duration_ms: 2800
```

#### Audit - Logs de Auditoria

```yaml
  /admin/audit-logs:
    get:
      tags:
        - Audit
      summary: Logs de auditoria de usu√°rios
      description: |
        Retorna hist√≥rico de a√ß√µes executadas por usu√°rios.
        Inclui detalhes de mudan√ßas (antes/depois).
      operationId: getAuditLogs
      parameters:
        - name: user_id
          in: query
          schema:
            type: integer
        - name: entity_type
          in: query
          schema:
            type: string
            enum: [USER, EXCHANGE_ACCOUNT, VAULT, POSITION, WEBHOOK_SOURCE, TRADE_JOB]
        - name: action
          in: query
          schema:
            type: string
            enum: [CREATE, UPDATE, DELETE, LOGIN, LOGOUT]
        - name: from
          in: query
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Logs de auditoria
          content:
            application/json:
              example:
                data:
                  - id: 12345
                    user_id: 2
                    user_email: trader@example.com
                    entity_type: POSITION
                    entity_id: 1542
                    action: UPDATE
                    changes:
                      before:
                        lock_sell_by_webhook: false
                        sl_enabled: true
                        sl_pct: 2.0
                      after:
                        lock_sell_by_webhook: true
                        sl_enabled: false
                        sl_pct: null
                    ip: "203.0.113.45"
                    user_agent: "Mozilla/5.0..."
                    request_id: "req_abc123xyz"
                    created_at: "2025-12-02T10:30:15Z"
                  - id: 12344
                    user_id: 1
                    user_email: admin@example.com
                    entity_type: USER
                    entity_id: 3
                    action: CREATE
                    changes:
                      after:
                        email: newtrader@example.com
                        full_name: Maria Trader
                        role: user
                    ip: "198.51.100.10"
                    user_agent: "PostmanRuntime/7.32.3"
                    request_id: "req_def456uvw"
                    created_at: "2025-12-02T09:15:20Z"
                pagination:
                  current_page: 1
                  per_page: 20
                  total_items: 2
                  total_pages: 1
```

---

# 8. Seguran√ßa e Requisitos N√£o Funcionais

* JWT + 2FA para usu√°rios.

* Criptografia forte (AES-256-GCM) para:

  * API keys de exchange
  * secrets de webhook.

* Valida√ß√£o de IP e assinatura HMAC nos webhooks (configur√°vel por `webhook_source`).

* Logs estruturados e auditoria:

  * **Audit logs de usu√°rios** (`audit_logs`):
    * Toda a√ß√£o de CREATE, UPDATE, DELETE √© registrada
    * Armazena estado antes/depois (changes_json)
    * Rastreamento de IP, user agent, request_id
    * Reten√ß√£o: 12 meses (configur√°vel)
  
  * **System audit logs** (`system_audit_logs`):
    * Eventos do sistema (crons, webhooks, execu√ß√µes)
    * Severidade (INFO, WARNING, ERROR, CRITICAL)
    * Alertas autom√°ticos para eventos cr√≠ticos
    * Reten√ß√£o: 6 meses para INFO, 24 meses para ERROR/CRITICAL
  
  * **Login history** (`login_history`):
    * Todas as tentativas de login (sucesso e falha)
    * Detec√ß√£o de m√∫ltiplas tentativas falhadas
    * Bloqueio tempor√°rio ap√≥s 5 falhas consecutivas
  
  * **Webhook logs**:
    * Todos os webhooks recebidos (sucesso e bloqueados)
    * Tentativas com IP n√£o autorizado
    * Falhas de assinatura HMAC
    * Rate limiting aplicado
  
  * **Compliance e LGPD**:
    * Export de dados pessoais do usu√°rio (JSON)
    * Anonimiza√ß√£o de dados em soft delete
    * Consentimento para armazenamento de dados
    * Direito ao esquecimento (hard delete com valida√ß√£o)

* Escalabilidade:

  * `apps/api` pode ser escalado horizontalmente.
  * Workers se escalam pelo BullMQ.
  * Banco MySQL dimensionado com √≠ndices apropriados.

* Observabilidade:

  * Healthcheck por servi√ßo.
  * Logs de n√≠vel `info`, `warn`, `error` com `requestId`/`traceId`.
  * Logs centralizados no diret√≥rio `/logs` na raiz do projeto.

* Deploy e Infraestrutura:

  * **Execu√ß√£o Local**: O projeto roda diretamente com Node.js, sem Docker.
  * **Requisitos**: MySQL 8 e Redis devem estar instalados localmente ou acess√≠veis via servi√ßos gerenciados.
  * **Vari√°veis de Ambiente**: Todas as configura√ß√µes via `.env` (veja `.env.example`).
  * **Documenta√ß√£o**: Instru√ß√µes completas de setup em `docs/SETUP.md`.
  * **Logs**: Diret√≥rio `/logs` na raiz do projeto para logs centralizados.

---
